!function(e){window.partner=e.fn.partner={changeBuyFpfsOrder:function(){""==e("#csBuyHidden")[0].value||"order_desc"==e("#csBuyHidden")[0].value?e("#csBuyHidden")[0].value="order_asc":"order_asc"==e("#csBuyHidden")[0].value&&(e("#csBuyHidden")[0].value="order_desc")},changeBuyAmountOrder:function(){""==e("#jeBuyHidden")[0].value||"order_desc"==e("#jeBuyHidden")[0].value?e("#jeBuyHidden")[0].value="order_asc":"order_asc"==e("#jeBuyHidden")[0].value&&(e("#jeBuyHidden")[0].value="order_desc")},changeSaleFpfsOrder:function(){""==e("#csSaleHidden")[0].value||"order_desc"==e("#csSaleHidden")[0].value?e("#csSaleHidden")[0].value="order_asc":"order_asc"==e("#csSaleHidden")[0].value&&(e("#csSaleHidden")[0].value="order_desc")},changeSaleAmountOrder:function(){""==e("#jeSaleHidden")[0].value||"order_desc"==e("#jeSaleHidden")[0].value?e("#jeSaleHidden")[0].value="order_asc":"order_asc"==e("#jeSaleHidden")[0].value&&(e("#jeSaleHidden")[0].value="order_desc")},querySaleData:function(t){e.jBox.tip("请求正在处理!请稍后......","loading"),e("#buyReportFlag").is(":checked")&&(e("#buyReportFlagHidden")[0].value="1"),(void 0==t||null==t)&&(t=1),e("#salePageNum")[0].value=t,e("#saleForm").attr("action",basePath+"enterprise/findEnterprisePartner"),e("#saleForm").submit()},queryBuyData:function(t){e.jBox.tip("请求正在处理!请稍后......","loading"),e("#saleReportFlag").is(":checked")&&(e("#saleReportFlagHidden")[0].value="1"),(void 0==t||null==t)&&(t=1),e("#buyPageNum")[0].value=t,e("#buyForm").attr("action",basePath+"enterprise/findEnterprisePartner"),e("#buyForm").submit()},displayGraph:function(t){e('[data-toggle="popover"]').popover();var a=800,r=300,n=(d3.format(",d"),d3.scale.category20(),d3.select("#graphDisplay").append("svg").attr("width",a).attr("height",r)),o=t,i={};i.fixed=!0,i.x=a/2,i.y=r/2,i.r=50,i.group=1,i.enterpriseName="undefined"!=typeof enterpriseName?enterpriseName:"",o.push(i);var l=0,d=0,s=0;o.sort(function(e,t){return e.amount>t.amount?1:-1}),o.forEach(function(e,t){e!=i&&(e.grade?e.group=e.grade.split("A").length-2:(e.group=3,e.grade="暂无评级"),e.r=20,"sale"==e.flag?(l++,e.index=l):"buy"==e.flag?(d++,e.index=d):"both"==e.flag&&(s++,e.index=s))});var u=0,c=0,p=0;0!=l&&(u=Math.floor(110/l)),0!=d&&(c=Math.floor(110/d)),0!=s&&(p=Math.floor(80/s)),o.forEach(function(e,t){if(e!=i){var a=130;if("buy"==e.flag){var r=-35+c*e.index;e.x=i.x+Math.sin(2*Math.PI/360*r)*a,e.y=i.y-Math.cos(2*Math.PI/360*r)*(a-20)}else if("sale"==e.flag){var r=90+u*e.index;e.x=i.x+Math.sin(2*Math.PI/360*r)*a,e.y=i.y-Math.cos(2*Math.PI/360*r)*(a-20)}else if("both"==e.flag){var r=225+p*e.index;e.x=i.x+Math.sin(2*Math.PI/360*r)*(a+18),e.y=i.y-Math.cos(2*Math.PI/360*r)*(a+18)}}});var y=["#FFCC00","#FF9900","#FF6600","#CCFFCC"],f=["A","AA","AAA","暂无评级"],h=n.selectAll(".legend").data(y).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(10,"+20*(t+1)+")"});h.append("rect").attr("x",78).attr("width",18).attr("height",18).on("mouseover",function(e,t){n.selectAll(".node").style("opacity",.1),n.selectAll(".link").style("opacity",.1),n.selectAll(".node").filter(function(e){return 1==e.group?e:void 0}).style("opacity",1),n.selectAll(".node").filter(function(e){return e.group==t?e:void 0}).style("opacity",1),n.selectAll(".link").filter(function(e){return e.source==t?e:void 0}).style("opacity",1)}).on("mouseout",function(){n.selectAll(".node").style("opacity",1),n.selectAll(".link").style("opacity",1)}).style("fill",function(e,t){return e}),h.append("text").data(f).attr("x",60).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(e){return e});{var g=(n.append("line").attr("x1",i.x).attr("y1",i.y).attr("x2",function(){return i.x+200*Math.sin(2*Math.PI/360*-45)}).attr("y2",function(){return i.y-200*Math.cos(2*Math.PI/360*-45)}).attr("stroke-width",3).attr("stroke","#C9E6E3"),n.append("line").attr("x1",i.x).attr("y1",i.y).attr("x2",function(){return i.x+200*Math.sin(2*Math.PI/360*-45)}).attr("y2",function(){return i.y+200*Math.cos(2*Math.PI/360*-45)}).attr("stroke-width",3).attr("stroke","#C9E6E3"),n.selectAll(".link").data(o).enter().append("line").attr("class","link").attr("x1",function(e){return i.x}).attr("y1",function(e){return i.y}).attr("x2",function(e){return e.x}).attr("y2",function(e){return e.y}).style("stroke-width",function(e,t){return t+2}).style("stroke",function(e){return"#22BDAF"}),n.selectAll(".node").data(o).enter().append("g").on("mouseenter",function(t){d3.select(this).select("circle").transition().duration(400).attr("r",t.r+2);var a=e(this).find("circle");a.popover("show"),setTimeout(function(){e(".popover").on("mouseleave",function(){a.popover("hide")})},100)}).on("mouseleave",function(t){d3.select(this).select("circle").transition().duration(400).attr("r",t.r);var a=e(this).find("circle");setTimeout(function(){e(".popover:hover").length||a.popover("hide")},100)}).attr("class","node"));2*Math.PI/360*30}g.append("circle").attr("r",function(e){return e.r?e.r:30}).attr("cx",function(e,t){return e==i?i.x:e.x}).attr("cy",function(e,t){return e==i?i.y:e.y}).style("fill",function(e){return e==i?"#99CCFF":y[e.group]}).attr("data-toggle","popover").attr("data-content",function(e){return e.content?e.content:e==i?"公司名称："+e.enterpriseName+"<br/>":"公司名称："+e.enterpriseName+"<br/>综合评级："+e.grade+"<br/>税号："+e.taxNo+"<br/>发票金额："+e.amount.formatMoney(2,"￥ ")}).attr("data-html",!0).attr("data-container","body"),g.append("text").filter(function(e){if(e!=i)return e;var t=this.parentNode;appendMultiText(d3.select(t),i.enterpriseName,i.x,i.y,80,16,"simsun")}).attr("x",function(e,t){return e==i?i.x:e.x}).attr("y",function(e,t){return e==i?i.y:e.y}).style("text-anchor","middle").text(function(e){return e==i?i.enterpriseName:"暂无评级"!==e.grade?e.grade:void appendMultiText(d3.select(this.parentNode),e.grade,e.x,e.y,25,12,"simsun")}).style("font-size",7).attr("dy",".5em");n.append("line").attr("x1",i.x+50).attr("y1",i.y).attr("x2",i.x+260).attr("y2",i.y).style("stroke-dasharray",4).attr("stroke-width",3).attr("stroke","#C9E6E3"),n.append("text").attr("x",i.x+240).attr("y",i.y-20).text("采购"),n.append("text").attr("x",i.x+240).attr("y",i.y+30).text("销售"),n.append("text").attr("x",i.x-220).attr("y",i.y-100).text("进销方")}}}(jQuery),jQuery(document).ready(function(e){var t=e("#saleA").attr("class"),a=e("#buyA").attr("class");"tab on"==t&&"tab"==a&&partner.querySaleData(),"1"==buyReportFlag&&e("#buyReportFlag").attr("checked","checked"),"1"==saleReportFlag&&e("#saleReportFlag").attr("checked","checked"),0!=saleTotalPages&&parseInt(saleTotalPages)>0&&e("#salePagination").bootpag({total:parseInt(saleTotalPages),page:salePageNum,maxVisible:10,leaps:!0}).on("page",function(e,t){partner.querySaleData(t)}),0!=buyTotalPages&&parseInt(buyTotalPages)>0&&e("#buyPagination").bootpag({total:parseInt(buyTotalPages),page:buyPageNum,maxVisible:10,leaps:!0}).on("page",function(e,t){partner.queryBuyData(t)}),partner.displayGraph(list)});